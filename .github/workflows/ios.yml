name: iOS Build

on:
  push:
    branches: [ "main" ]
    paths:
      - 'ios/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'ios/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: macos-14  # macOS Sonoma with Xcode 15

    steps:
    - uses: actions/checkout@v4

    - name: Select Xcode version
      run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Create Xcode project
      run: |
        cd ios/FoodTracking
        # Create a basic Package.swift for building
        cat > Package.swift << 'EOF'
        // swift-tools-version: 5.9
        import PackageDescription

        let package = Package(
            name: "FoodTracking",
            platforms: [.iOS(.v17)],
            products: [
                .library(name: "FoodTracking", targets: ["FoodTracking"])
            ],
            targets: [
                .target(
                    name: "FoodTracking",
                    path: "FoodTracking",
                    exclude: ["Info.plist", "FoodTracking.entitlements"]
                )
            ]
        )
        EOF

    - name: Build Swift Package
      run: |
        cd ios/FoodTracking
        swift build -Xswiftc -sdk -Xswiftc $(xcrun --sdk iphonesimulator --show-sdk-path) \
          -Xswiftc -target -Xswiftc arm64-apple-ios17.0-simulator

    - name: Syntax Check (fallback)
      if: failure()
      run: |
        cd ios/FoodTracking/FoodTracking
        for file in *.swift Models/*.swift Views/*.swift Services/*.swift Views/Components/*.swift; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            swiftc -typecheck -sdk $(xcrun --sdk iphonesimulator --show-sdk-path) \
              -target arm64-apple-ios17.0-simulator "$file" 2>&1 || true
          fi
        done

    - name: Upload iOS Source
      uses: actions/upload-artifact@v4
      with:
        name: ios-source
        path: ios/FoodTracking/
